<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Contenedores - Ecoembes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-light">

<!-- Header -->
<header class="bg-success shadow-sm">
    <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center">
            <a href="/" class="text-decoration-none text-white">
                <i class="fas fa-recycle fa-2x me-2"></i>
                <span class="fs-3 fw-bold">Ecoembes</span>
            </a>
            <a th:href="@{/(token=${token})}" class="btn btn-light btn-sm">
                <i class="fas fa-home me-2"></i>Volver al Inicio
            </a>
        </div>
    </div>
</header>

<!-- Navbar -->
<nav class="navbar navbar-light bg-white shadow-sm">
    <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-dumpster me-2 text-primary"></i>
                Gestión de Contenedores
            </span>
    </div>
</nav>

<!-- Contenido Principal -->
<div class="container mt-4">

    <!-- Título -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5">
                <i class="fas fa-dumpster text-primary me-2"></i>
                Contenedores Disponibles
            </h1>
            <p class="lead text-muted">
                Estado actual de todos los contenedores de reciclaje
            </p>
        </div>
    </div>

    <!-- Mensaje de error global -->
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Grid de Paneles de Contenedores -->
    <div class="row g-4">

        <div th:each="contenedor : ${contenedores}" class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm"
                 th:classappend="${contenedor.cantidad > 80 ? 'border-danger' : contenedor.cantidad > 50 ? 'border-warning' : 'border-success'}">

                <div class="card-header text-white"
                     th:classappend="${contenedor.cantidad > 80 ? 'bg-danger' : contenedor.cantidad > 50 ? 'bg-warning' : 'bg-success'}">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trash-alt me-2"></i>
                        Contenedor #<span th:text="${contenedor.id}">ID</span>
                    </h5>
                </div>

                <div class="card-body"
                     th:style="${contenedor.cantidad > 80 ? 'background-color: #f8d7da;' : contenedor.cantidad > 50 ? 'background-color: #fff3cd;' : 'background-color: #d1e7dd;'}">

                    <div class="mb-3">
                        <h6 class="fw-bold">
                            <i class="fas fa-chart-line me-2"></i>
                            Estado Actual
                        </h6>
                        <div class="d-flex justify-content-between align-items-center p-3 bg-white rounded">
                            <span class="fw-bold">Cantidad:</span>
                            <span class="fs-4 fw-bold" th:text="${contenedor.cantidad} + ' kg'">0 kg</span>
                        </div>
                    </div>

                    <div class="alert mb-3"
                         th:classappend="${contenedor.cantidad > 80 ? 'alert-danger' : contenedor.cantidad > 50 ? 'alert-warning' : 'alert-success'}">
                        <strong>
                            <i th:if="${contenedor.cantidad > 80}" class="fas fa-exclamation-triangle me-2"></i>
                            <i th:if="${contenedor.cantidad > 50 && contenedor.cantidad <= 80}" class="fas fa-exclamation-circle me-2"></i>
                            <i th:if="${contenedor.cantidad <= 50}" class="fas fa-check-circle me-2"></i>
                            <span th:if="${contenedor.cantidad > 80}">Nivel ALTO - Requiere vaciado</span>
                            <span th:if="${contenedor.cantidad > 50 && contenedor.cantidad <= 80}">Nivel MEDIO</span>
                            <span th:if="${contenedor.cantidad <= 50}">Nivel BAJO - Operativo</span>
                        </strong>
                    </div>

                    <!-- Botón para mostrar formulario -->
                    <button class="btn btn-outline-primary btn-sm w-100"
                            type="button"
                            th:onclick="'toggleHistorial(' + ${contenedor.id} + ')'">
                        <i class="fas fa-history me-2"></i>Consultar Historial
                    </button>

                    <!-- Formulario de historial (oculto inicialmente) -->
                    <div th:id="'historial-form-' + ${contenedor.id}"
                         class="border-top pt-3 mt-3"
                         style="display: none;">

                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Rango de Fechas
                        </h6>

                        <form method="get" th:action="@{/contenedores/historial}">
                            <input type="hidden" name="token" th:value="${token}">
                            <input type="hidden" name="contenedorId" th:value="${contenedor.id}">

                            <div class="input-group input-group-sm mb-2">
                                    <span class="input-group-text">
                                        <i class="fas fa-calendar-day"></i> Desde
                                    </span>
                                <input type="text"
                                       class="form-control"
                                       name="fechaInicio"
                                       placeholder="dd-MM-yyyy"
                                       pattern="\d{2}-\d{2}-\d{4}"
                                       required>
                            </div>

                            <div class="input-group input-group-sm mb-2">
                                    <span class="input-group-text">
                                        <i class="fas fa-calendar-day"></i> Hasta
                                    </span>
                                <input type="text"
                                       class="form-control"
                                       name="fechaFin"
                                       placeholder="dd-MM-yyyy"
                                       pattern="\d{2}-\d{2}-\d{4}"
                                       required>
                            </div>

                            <button type="submit" class="btn btn-primary btn-sm w-100">
                                <i class="fas fa-search me-1"></i>Consultar
                            </button>
                        </form>
                    </div>

                </div>

            </div>
        </div>

    </div>

    <!-- Mensaje si no hay contenedores -->
    <div th:if="${contenedores == null || contenedores.isEmpty()}" class="alert alert-warning mt-4" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        No hay contenedores disponibles en este momento.
    </div>

    <!-- SECCIÓN DE RESULTADOS DE HISTORIAL (fuera del bucle) -->
    <div th:if="${contenedorConsultado != null}" class="row mt-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Historial - Contenedor #<span th:text="${contenedorConsultado}"></span>
                    </h4>
                </div>

                <div class="card-body">

                    <!-- Información del rango -->
                    <div th:if="${historialResultado != null}" class="alert alert-info">
                        <strong><i class="fas fa-info-circle me-2"></i>Período consultado:</strong>
                        Del <span th:text="${fechaInicioConsultada}"></span>
                        al <span th:text="${fechaFinConsultada}"></span>
                    </div>

                    <!-- Tabla de estados -->
                    <div th:if="${historialResultado != null && !historialResultado.isEmpty()}">
                        <table class="table table-striped table-hover">
                            <thead class="table-primary">
                            <tr>
                                <th><i class="fas fa-calendar me-2"></i>Fecha y Hora</th>
                                <th><i class="fas fa-weight me-2"></i>Cantidad (kg)</th>
                                <th><i class="fas fa-signal me-2"></i>Estado</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="estado : ${historialResultado}">
                                <td th:text="${#dates.format(estado.fecha, 'dd-MM-yyyy HH:mm')}"></td>
                                <td><strong th:text="${estado.cantidad}"></strong> kg</td>
                                <td>
                                            <span class="badge"
                                                  th:classappend="${estado.cantidad > 80 ? 'bg-danger' : estado.cantidad > 50 ? 'bg-warning text-dark' : 'bg-success'}">
                                                <span th:if="${estado.cantidad > 80}">ALTO</span>
                                                <span th:if="${estado.cantidad > 50 && estado.cantidad <= 80}">MEDIO</span>
                                                <span th:if="${estado.cantidad <= 50}">BAJO</span>
                                            </span>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Error de historial -->
                    <div th:if="${errorHistorial != null}" class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span th:text="${errorHistorial}"></span>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>

<!-- Footer -->
<footer class="bg-light border-top mt-5 py-3">
    <div class="container text-center">
        <p class="text-muted mb-0">
            <i class="fas fa-graduation-cap text-primary"></i>
            Creado para la asignatura de <strong>Diseño del Software</strong>.
            <strong>Universidad de Deusto</strong> (2025).
        </p>
    </div>
</footer>

<!-- JavaScript -->
<script>
    function toggleHistorial(contenedorId) {
        var form = document.getElementById('historial-form-' + contenedorId);
        if (form.style.display === 'none') {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>